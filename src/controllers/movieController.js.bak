const { makeApiRequest } = require('../utils/movieboxClient');
const axios = require('axios');

// HELPER BARU: Menyesuaikan format data MovieBox V2 ke format Frontend
const formatMovieItem = (item) => {
    // Menangani item dari banner, topPick, homeList, dan subjectList
    const movie = item.subject || item;
    
    return {
        // Gunakan subjectId jika ada, jika tidak pakai id biasa
        videoId: movie.subjectId || movie.id,
        title: movie.title,
        cover: movie.cover?.url || movie.stills?.url || 'https://i.ibb.co/6Hwz2p6/placeholder.png',
        videoUrl: null, 
        views: movie.viewCount ? `${(movie.viewCount / 1000).toFixed(1)}K` : (movie.imdbRatingCount ? `${(movie.imdbRatingCount / 1000).toFixed(1)}K` : '0'),
        duration: movie.duration > 60 ? `${Math.floor(movie.duration / 60)} min` : (movie.duration || 'N/A'),
        type: movie.subjectType === 1 ? 'movie' : 'series'
    };
};

// CONTROLLER UTAMA
exports.getHomeData = async (req, res) => {
    try {
        const response = await makeApiRequest('/wefeed-h5-bff/web/home');
        const rawData = response.data?.data || {};

        let trending = [];
        let recommended = [];

        // 1. Ambil dari Banner (Gambar Besar di Atas)
        if (rawData.operatingList) {
            const bannerModule = rawData.operatingList.find(op => op.type === "BANNER");
            if (bannerModule && bannerModule.banner && bannerModule.banner.items) {
                trending = bannerModule.banner.items.map(formatMovieItem);
            }
        }
        
        // 2. Ambil dari 'homeList' atau 'topPickList' jika ada
        if (rawData.homeList && rawData.homeList.length > 0) {
            recommended.push(...rawData.homeList.map(formatMovieItem));
        }
        if (rawData.topPickList && rawData.topPickList.length > 0) {
            recommended.push(...rawData.topPickList.map(formatMovieItem));
        }

        // 3. Fallback jika 'trending' masih kosong, ambil dari API Trending manual
        if (trending.length === 0) {
            const trendRes = await makeApiRequest('/wefeed-h5-bff/web/subject/trending', { 
                params: { page: 0, perPage: 15 } 
            });
            
            if (trendRes.data?.data?.subjectList) {
                const trendSubjects = trendRes.data.data.subjectList;
                trending = trendSubjects.map(formatMovieItem);
            }
        }

        // Jika recommended kosong, isi dengan sisa trending
        if (recommended.length === 0 && trending.length > 5) {
            recommended = trending.slice(5);
        }

        res.json({
            success: true,
            data: {
                trending: trending.slice(0, 10),
                // 'anime' tidak ada di response baru, jadi kita kosongkan atau isi dari rekomendasi
                anime: [], 
                recommended: recommended.slice(0, 20)
            }
        });

    } catch (error) {
        res.status(500).json({
            success: false,
            message: error.message,
            data: { trending: [], anime: [], recommended: [] }
        });
    }
};

exports.searchMovies = async (req, res) => {
    try {
        const query = req.query.q || req.params.query;
        if (!query) return res.json({ success: true, data: [] });

        const payload = {
            keyword: query,
            page: 1,
            perPage: 24,
            subjectType: 0
        };

        const response = await makeApiRequest('/wefeed-h5-bff/web/subject/search', {
            method: 'POST',
            data: payload
        });

        const items = response.data?.data?.items || [];
        res.json({
            success: true,
            data: items.map(formatMovieItem)
        });

    } catch (error) {
        res.status(500).json({ success: false, data: [] });
    }
};

exports.getVideoDetail = async (req, res) => {
    try {
        const { id } = req.params;

        const infoResponse = await makeApiRequest('/wefeed-h5-bff/web/subject/detail', {
            params: { subjectId: id }
        });
        const subject = infoResponse.data?.data?.subject;

        if (!subject) throw new Error("Video not found");

        const detailPath = subject.detailPath;
        let sources = [];
        let finalVideoUrl = null;

        if (detailPath) {
            const refererUrl = `https://fmoviesunblocked.net/spa/videoPlayPage/movies/${detailPath}?id=${id}&type=/movie/detail`;
            try {
                const sourceResponse = await makeApiRequest('/wefeed-h5-bff/web/subject/download', {
                    params: { subjectId: id, se: 0, ep: 0 },
                    headers: { 'Referer': refererUrl, 'Origin': 'https://fmoviesunblocked.net' }
                });

                const downloads = sourceResponse.data?.data?.downloads || [];
                sources = downloads.map(file => ({
                    quality: file.resolution || 'Original',
                    videoUrl: `${req.protocol}://${req.get('host')}/api/download/${encodeURIComponent(file.url)}`,
                    size: file.size
                }));

                if (sources.length > 0) {
                    finalVideoUrl = sources[sources.length - 1].videoUrl;
                }
            } catch (err) {
                // Ignore source error
            }
        }

        const movieData = {
            videoId: subject.id,
            title: subject.title,
            description: subject.intro,
            cover: subject.cover?.url || subject.stills?.url,
            videoUrl: finalVideoUrl,
            sources: sources,
            views: subject.viewCount ? `${(subject.viewCount / 1000).toFixed(1)}K` : 'N/A',
            duration: subject.duration || 'N/A',
            tags: subject.tagList ? subject.tagList.map(t => t.name) : [],
            author: { name: "MovieBox", avatar: "https://i.ibb.co/27ymgy5Z/abmoviev1.jpg" }
        };

        res.json({ success: true, data: movieData });

    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
};

exports.proxyDownload = async (req, res) => {
    try {
        const targetUrl = decodeURIComponent(req.params[0]);
        if (!targetUrl) return res.status(400).send("Invalid URL");

        const headers = {
            'User-Agent': 'okhttp/4.12.0',
            'Referer': 'https://fmoviesunblocked.net/',
        };
        if (req.headers.range) {
            headers['Range'] = req.headers.range;
        }

        const response = await axios({
            method: 'GET',
            url: targetUrl,
            responseType: 'stream',
            headers: headers
        });

        const head = {
            'Content-Type': response.headers['content-type'],
            'Content-Length': response.headers['content-length'],
            'Accept-Ranges': 'bytes'
        };
        
        if (response.status === 206) {
            head['Content-Range'] = response.headers['content-range'];
            res.writeHead(206, head);
        } else {
            res.writeHead(200, head);
        }

        response.data.pipe(res);
    } catch (error) {
        if (!res.headersSent) res.status(500).send("Stream Error");
    }
};